<!DOCTYPE html>
<html class="writer-html5" lang="zh" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>虚拟机高低优先级 - OpenStack SIG Doc</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u865a\u62df\u673a\u9ad8\u4f4e\u4f18\u5148\u7ea7";
        var mkdocs_page_input_path = "spec/priority_vm.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> OpenStack SIG Doc
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="搜索文档" title="在此输入需要搜索的内容" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航栏">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">OpenStack SIG</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">贡献指导</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../contribute/rpm-packaging-reference/">RPM开发流程</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">安装指导</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/devstack/">devstack</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-20.03-LTS-SP2/OpenStack-queens/">openEuler-20.03-LTS-SP2_Queens</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-20.03-LTS-SP2/OpenStack-rocky/">openEuler-20.03-LTS-SP2_Rocky</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-20.03-LTS-SP3/OpenStack-queens/">openEuler-20.03-LTS-SP3_Queens</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-20.03-LTS-SP3/OpenStack-rocky/">openEuler-20.03-LTS-SP3_Rocky</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-20.03-LTS-SP3/OpenStack-train/">openEuler-20.03-LTS-SP3_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-21.09/OpenStack-wallaby/">openEuler-21.09_Wallaby</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-22.03-LTS/OpenStack-train/">openEuler-22.03-LTS_Train</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../install/openEuler-22.03-LTS/OpenStack-wallaby/">openEuler-22.03-LTS_Wallaby</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">测试报告</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../test/openEuler-20.03-LTS-SP2/">openEuler-20.03-LTS-SP2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../test/openEuler-20.03-LTS-SP3/">openEuler-20.03-LTS-SP3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../test/openEuler-22.03-LTS/">openEuler-22.03-LTS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">自研特性</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">虚拟机高低优先级</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">实现方案</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">实现细节</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_4">资源模型</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#api">API</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler">Scheduler</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#compute">Compute</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_5">资源上报</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#_6">资源分配绑定</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#xml">虚拟机xml</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_7">开发节奏</a>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="移动导航栏">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">OpenStack SIG Doc</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="文档"></a> &raquo;</li>
          <li>自研特性 &raquo;</li><li>虚拟机高低优先级</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">高低优先级虚拟机混部<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>虚拟机混合部署是指把对CPU、IO、Memory等资源有不同需求的虚拟机通过调度方式部署、迁移到同一个计算节点上，从而使得节点的资源得到充分利用。</p>
<p>虚拟机混合部署的场景有多种，比如通过动态资源调度满足节点资源的动态调整；根据用户使用习惯动态调整节点虚拟机分布等等。而虚拟机高低优先级调度也是其中的一种实现方法。</p>
<p>在OpenStack Nova中引入虚拟机高低优先级技术，可以一定程度上满足虚拟机的混合部署要求。</p>
<p>本特性主要针对OpenStack Nova虚拟机创建功能，介绍虚拟机高低优先级调度的设计与实现。</p>
<h2 id="_2">实现方案<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>在Nova的虚拟机创建、迁移流程中引入高低优先级概念，虚拟机对象新增高低优先级属性。高优先级虚拟机在调度的过程中，会尽可能的调度到资源充足的节点，这样的节点需要至少满足内存不超卖、高优先级虚拟机所用CPU不超卖的要求。</p>
<h2 id="_3">实现细节<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>本特性的实现基于即将发布的OpenStack Yoga版本，承载于openEuler 22.09创新版本中。</p>
<p>高优先级虚机特性与Nova绑核功能相关，例如，高优先级只能是绑核虚机，低优先级虚机只能是非绑核虚机</p>
<p><strong>绑核</strong>: 指VM核心与物理机核心一比一映射，在nova中以<code>cpu_dedicated_set</code>配置项表示</p>
<p><strong>非绑核</strong>: 指VM的核心在一组物理核心上范围绑定，漂浮不定，在nova中以<code>cpu_shared_set</code>配置项表示</p>
<h3 id="_4">资源模型<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>VM对象新增可选属性<code>priority</code>，不进行设置时表示是一个普通VM。<code>priority</code>可被设置成<code>high</code>或<code>low</code>，分别表示高低优先级。</p>
</li>
<li>
<p>flavor extra_specs新增<code>hw:cpu_priority</code>字段，标识为高低优先级虚拟机规格，值为<code>high</code>或<code>low</code>。</p>
</li>
<li>
<p><code>nova.conf</code>的<code>compute</code>块中新增配置项<code>cpu_priority_mix_enable</code>，默认值为False，设置为True后，低优先级虚拟机可使用高优先级的虚拟机绑定的CPU，即低优先级虚拟机可使用的CPU为<code>cpu_shared_set</code>与<code>cpu_dedicated_set</code>中设置的CPU号之和。</p>
</li>
</ul>
<h3 id="api">API<a class="headerlink" href="#api" title="Permanent link">&para;</a></h3>
<p>创建虚拟机API中可选参数<code>os:scheduler_hints.priority</code>可被设置成<code>high</code>或<code>low</code>，若flavor中也配置了<code>hw:cpu_priority</code>，则<code>os:scheduler_hints.priority</code>优先级最高。</p>
<pre class="highlight"><code>POST v2/servers (v2.1默认版本)
{
    "OS-SCH-HNT:scheduler_hints": {"priority": "high"}
}</code></pre>
<p>参数限制：</p>
<ol>
<li><code>priority=high</code>必须与<code>hw:cpu_policy=dedicated</code>配套使用，否则报错</li>
<li><code>priority=low</code>必须与<code>hw:cpu_policy=shared</code>(默认值)配套使用，否则报错</li>
</ol>
<h3 id="scheduler">Scheduler<a class="headerlink" href="#scheduler" title="Permanent link">&para;</a></h3>
<p>Scheduler保持不变</p>
<p>高低优先级特性引入后，scheduler和compute视角看到的资源可能不一致，举例：</p>
<p>假设一个compute节点拥有14个core，设置cpu_dedicated_set=0-11,一共12个核，cpu_shared_set=12-13，一共2个核心,cpu_allocation_ratio=8 则：</p>
<ol>
<li>高优VM在schdeduler视角可用core为12，compute实际可用core也是12</li>
<li>低优VM在schdeduler视角可用core为2 * 8 = 16，compute实际可用为2 * 8(当cpu_priority_mix_enable=False)</li>
<li>低优VM在schdeduler视角可用core为2 * 8 = 16，compute实际可用为2 * 8 +12(当cpu_priority_mix_enable=True)</li>
</ol>
<p>存在的问题：</p>
<ol>
<li>
<p>底层资源充足，但scheduler看不到全局，导致调度失败</p>
<p>解决方法：管理员按照一个合理的计算公式，配置合理的cpu_allocation_ratio，降低该问题出现的概率。</p>
<p>例如：计算公式可以是</p>
<pre class="highlight"><code>(用户期望的全局超分比 * compute所有核心数 - dedicated核心数) / shared核心数 = cpu_allocation_ratio</code></pre>
<p>以上面14 core的compute节点为例</p>
<pre class="highlight"><code>(用户期望的全局超分比 * 14 - 12) / 2 = 8
计算可得，用户期望的全局超分比 = 2</code></pre>
</li>
</ol>
<h3 id="compute">Compute<a class="headerlink" href="#compute" title="Permanent link">&para;</a></h3>
<h4 id="_5">资源上报<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>保持不变</p>
<h4 id="_6">资源分配绑定<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>高低优先级机器创建按照priority标志分配CPU：</p>
<ul>
<li>高优先级虚拟机绑定<code>cpu_dedicated_set</code>中指定CPU</li>
<li>低优先级虚拟机默认绑定<code>cpu_shared_set</code>中指定的CPU，当<code>cpu_priority_mix_enable=True</code>时，可以绑定<code>cpu_shared_set</code> + <code>cpu_dedicated_set</code>中指定CPU</li>
</ul>
<h4 id="xml">虚拟机xml<a class="headerlink" href="#xml" title="Permanent link">&para;</a></h4>
<p>高低优先级机器创建按照priority标志，对虚拟机进行标识</p>
<ul>
<li>Libirt XML中新增属性<code>&lt;resource&gt;</code>片段，包括 <code>/high_prio_machine</code>、<code>/low_prio_machine</code>两种值，分别表示高低优先级虚拟机。该片段本身没有任何效率，只是为<code>skylark</code> QOS服务指明VM的高低优先级属性。</li>
</ul>
<h2 id="_7">开发节奏<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>开发者：</p>
<ul>
<li>王玺源<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#119;&#97;&#110;&#103;&#120;&#105;&#121;&#117;&#97;&#110;&#49;&#48;&#48;&#55;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#119;&#97;&#110;&#103;&#120;&#105;&#121;&#117;&#97;&#110;&#49;&#48;&#48;&#55;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></li>
<li>郭雷<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#103;&#117;&#111;&#108;&#101;&#105;&#95;&#121;&#101;&#119;&#117;&#64;&#99;&#109;&#115;&#115;&#46;&#99;&#104;&#105;&#110;&#97;&#109;&#111;&#98;&#105;&#108;&#101;&#46;&#99;&#111;&#109;">&#103;&#117;&#111;&#108;&#101;&#105;&#95;&#121;&#101;&#119;&#117;&#64;&#99;&#109;&#115;&#115;&#46;&#99;&#104;&#105;&#110;&#97;&#109;&#111;&#98;&#105;&#108;&#101;&#46;&#99;&#111;&#109;</a></li>
<li>马干林<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#109;&#97;&#103;&#97;&#110;&#108;&#105;&#110;&#95;&#121;&#101;&#119;&#117;&#64;&#99;&#109;&#115;&#115;&#46;&#99;&#104;&#105;&#110;&#97;&#109;&#111;&#98;&#105;&#108;&#101;&#46;&#99;&#111;&#109;">&#109;&#97;&#103;&#97;&#110;&#108;&#105;&#110;&#95;&#121;&#101;&#119;&#117;&#64;&#99;&#109;&#115;&#115;&#46;&#99;&#104;&#105;&#110;&#97;&#109;&#111;&#98;&#105;&#108;&#101;&#46;&#99;&#111;&#109;</a></li>
<li>韩光宇<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#104;&#97;&#110;&#103;&#117;&#97;&#110;&#103;&#121;&#117;&#64;&#117;&#110;&#105;&#111;&#110;&#116;&#101;&#99;&#104;&#46;&#99;&#111;&#109;">&#104;&#97;&#110;&#103;&#117;&#97;&#110;&#103;&#121;&#117;&#64;&#117;&#110;&#105;&#111;&#110;&#116;&#101;&#99;&#104;&#46;&#99;&#111;&#109;</a></li>
<li>张迎<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#122;&#104;&#97;&#110;&#103;&#121;&#49;&#51;&#49;&#55;&#64;&#102;&#111;&#120;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#122;&#104;&#97;&#110;&#103;&#121;&#49;&#51;&#49;&#55;&#64;&#102;&#111;&#120;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></li>
<li>张帆<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#122;&#104;&#46;&#102;&#64;&#111;&#117;&#116;&#108;&#111;&#111;&#107;&#46;&#99;&#111;&#109;">&#122;&#104;&#46;&#102;&#64;&#111;&#117;&#116;&#108;&#111;&#111;&#107;&#46;&#99;&#111;&#109;</a></li>
</ul>
<p>时间点：</p>
<ul>
<li>2022-04-01到2022-05-30 完成开发</li>
<li>2022-06-01到2022-07-30 测试、联调、刷新代码</li>
<li>2022-08-01到2022-08-30 完成RPM包构建</li>
<li>2022-09-30正式发布</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="页脚导航">
        <a href="../../test/openEuler-22.03-LTS/" class="btn btn-neutral float-left" title="openEuler-22.03-LTS"><span class="icon icon-circle-arrow-left"></span> 上一张</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  用<a href="https://www.mkdocs.org/">MkDocs</a>构建，使用<a href="https://readthedocs.org">Read the Docs</a>提供的<a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>。
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="版本">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../test/openEuler-22.03-LTS/" style="color: #fcfcfc">&laquo; 上一张</a></span>
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
